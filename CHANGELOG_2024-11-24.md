# 更新日誌 - 2025/11/24

這次主要做了等級系統，另外修了一堆之前就想處理的 bug。UI 調整花了不少時間，尤其是按鈕位置的問題，終於搞定了。

## 加了什麼

### 等級系統

做了一個 1 到 30 級的系統，發訊息就能累積經驗值：
- 發文字訊息 +10
- 發圖片 +15
- 語音訊息 +20
- 發起投票或搶答 +25
- 解鎖成就 +50

升級的時候會跳個動畫出來，感覺還不錯。每個等級都有自己的徽章顏色，會顯示在訊息旁邊和側邊欄。

### 稱號

根據你的等級和訊息數量會自動給稱號，總共 6 種：
- 新手（剛開始）
- 活躍者（發了 50 條訊息）
- 老手（200 條訊息）
- 大師（10 級）
- 傳奇（20 級）
- 冠軍（500 條訊息）

達成條件後就會自動解鎖，還會跳通知。

### 成就系統

設計了 12 個成就可以收集：
- 💬 初次發言
- 🗣️ 健談（10 條訊息）
- 💭 話癆（50 條訊息）
- 🎤 聊天大師（100 條訊息）
- ⭐ 小有名氣（5 級）
- 🌟 知名人士（10 級）
- ✨ 傳奇人物（20 級）
- 🗳️ 民主先鋒（發起投票）
- 🧠 出題者（發起搶答）
- 😊 反應靈敏（用了 10 個表情）
- 🎙️ 語音達人（5 次語音）
- 📷 攝影師（10 張圖片）

成就會自動追蹤進度，達成的時候還有經驗值獎勵。

### 個人檔案頁面

點頭像就能開啟個人檔案，可以看到：
- 等級和經驗值（有進度條）
- 目前的稱號
- 總共發了幾則訊息
- 成就解鎖狀態
- 徽章收藏

所有資料都存在 localStorage，重開網頁還在。

## 修了什麼

### 按鈕擋到訊息

之前回覆按鈕和表情符號按鈕會蓋到上一條訊息，看起來很亂。改成把按鈕移到訊息右邊外面，不會再擋到內容了。

具體來說：
- 表情按鈕和回覆按鈕都移到右側
- 訊息之間多留了一些間距
- 滑鼠移過去才會顯示按鈕

### 個人檔案視窗關不掉

個人檔案的右上角 × 按鈕點了沒反應，原來是有兩個 `closeModals()` 函數定義衝突了。刪掉重複的就正常了。

### 頭像不見了

登入的時候側邊欄頭像沒顯示出來。加了初始化的程式碼，現在會正確顯示 emoji、圖片網址、或 data URI 三種類型的頭像。

### 語音訊息回覆顯示不清楚

之前回覆語音訊息時只會顯示「語音訊息」，看不出來內容是什麼。現在如果有語音轉文字，就會顯示 `🎤 "轉文字內容"`，比較清楚。

### 訊息發不出去

有時候按發送後訊息不會出現在聊天室。加了 WebSocket 連線檢查，如果還沒連上就會提示「連線尚未建立，請稍後再試」，不會讓訊息消失。

### 後端錯誤日誌太多

後端一直出現 "connection was aborted" 的錯誤訊息，其實只是使用者正常斷線而已。寫了一個 `safeWriteJSON()` 來過濾這些常見的斷線錯誤，日誌乾淨多了。

## 技術細節

### 後端改動

**models/models.go**
在 `Client` 和 `Message` 結構裡加了等級相關的欄位：
```go
Level    int    `json:"level"`
Exp      int    `json:"exp"`
Title    string `json:"title"`
```

還新增了 `UserProfile` 和 `Achievement` 兩個結構來處理個人資料和成就資料。

**service/service.go & message_handler.go**
加了 `safeWriteJSON()` 來處理 WebSocket 寫入錯誤，會過濾掉這些常見的斷線訊息：
- "use of closed network connection"
- "connection was aborted"
- "broken pipe"

所有廣播函數都改用這個安全寫入方式。

### 前端改動

**index.html**
這次加了 600 多行，主要是：

核心函數：
- `addExp()` - 加經驗值和檢查升級
- `showLevelUpAnimation()` - 升級動畫
- `updateUserLevelUI()` - 更新 UI
- `checkAchievements()` - 檢查成就
- `unlockAchievement()` - 解鎖成就
- `checkTitles()` - 檢查稱號
- `showProfileModal()` - 顯示個人檔案
- `onMessageSent()` - 追蹤訊息發送

資料結構：
- `expTable` - 30 級的經驗值表
- `titles` - 6 種稱號定義
- `achievements` - 12 個成就定義

CSS 部分加了 200 多行，包含等級徽章、稱號徽章、經驗條、個人檔案卡片、成就列表、升級動畫等樣式。

## 文件

新增了 `README_LEVEL_SYSTEM.md`（339 行），內容包括：
- 功能說明
- 使用指南
- 經驗值計算表
- 成就收集攻略
- 技術細節
- 常見問題

## 統計數字

改動的檔案：
```
chatroom/models/models.go           +30 行
chatroom/service/service.go         +17, -30 行
chatroom/service/message_handler.go +1, -4 行
chatroom/static/index.html          +655, -13 行
README_LEVEL_SYSTEM.md              +339 行（新檔案）
chatroom/leaderboard.json           +8 行（新檔案）
```

總共新增了 1000 多行程式碼。

Git 提交了 5 次：
1. eb59a51 - Backend: 新增等級系統資料結構
2. 77c630e - Backend: 改善 WebSocket 錯誤處理
3. a720bec - Frontend: 完整等級系統與 UI 修復
4. 213d2b0 - Docs: 新增等級系統說明文件
5. 4c91fe5 - Data: 新增排行榜資料檔案

## 注意事項

1. 等級資料存在瀏覽器本機，換電腦就要重練了
2. 清除瀏覽器資料會讓等級消失
3. 之後可能要做後端同步功能

## 後續計畫

短期內想做的：
- 移除 debug log
- 多加一些成就類型
- 優化手機版的顯示
- 效能測試

中期：
- 後端儲存等級資料
- 全域排行榜
- 等級特殊權限
- 個人頁面自訂功能

長期：
- 公會/團隊系統
- 每日/每週任務
- 特殊活動獎勵
- 社交互動功能


## 相關連結

- GitHub: https://github.com/Xian37/2025_GO_Project
- 語音功能說明: README_VOICE_FEATURES.md
- 回覆與 Markdown: README_REPLY_MARKDOWN.md
- 等級系統說明: README_LEVEL_SYSTEM.md

---

這次更新算是個里程碑，把聊天室變成有遊戲性質的社交平台。使用者現在有更多動機去互動和參與，希望能讓聊天室更有趣一點。
